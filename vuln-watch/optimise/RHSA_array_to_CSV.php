#!/usr/bin/php
<?php

$options = getopt("r:");

$OSVER=abs($options['r']);

$REPORT="redhat-".$OSVER."-report.csv";
$INPUT="redhat-array.html";

$data=file_get_contents($INPUT);


$last_run_file="redhat-lastrun";

$last_run_date=date_create("1970-1-1");

if (file_exists($last_run_file)) {
        $read_date=file_get_contents($last_run_file);
        $last_run_date=date_create($read_date);
};


$names=array("Reference", "Urgency", "URL", "Description", "Products", "Type", "ReleaseDate");


$words = array();
$delim = "[]";
$tok = strtok($data, $delim);
while ($tok !== false) {

	#print "$tok\n";

	$arr=split(",",$tok);
	if ($arr [0]!="" && count($arr)==5){

		# dont need the first value
		$tmp=array_shift($arr);

	#	[2] => '<a id="synopsis_3" href="/errata/RHSA-2015-0794.html">Moderate: krb5 security update</a>'

		$regex='|href="(.*?)">(.*?)<|';
		$matches=array();
		preg_match($regex,$arr[2],$matches);
		if (count($matches)==3) {
			$arr[]=$matches[1];
			$arr[]=$matches[2];
		};
		# remove unwanted array item
		unset($arr[2]);

	#	print_r($arr);
		$ref=substr(trim($arr[1],"'"),2,2);

		switch ($ref) {
			case "SA":
				$type="Security";
				break;
			case "BA":
				$type="Bug Fix";
				break;
			case "EA":
				$type="Enhancement";
				break;
			default:
				$type=$ref;
				break;
		};

/*
            [0] => 'Moderate'
            [1] => 'RHSA-2015:0797'
            [3] => '2015-04-10'
            [4] => /errata/RHSA-2015-0797.html
            [5] => Moderate: xorg-x11-server security update
*/

		$hash=[
			$names[0] => trim($arr[1],"'"), /*Reference*/
			$names[1] => trim($arr[0],"'"), /*Urgency*/
			# arr[2] deleted
			$names[2] => "https://rhn.redhat.com".$arr[4], /*URL*/
			$names[3] => $arr[5], /*Descr*/
			$names[4] => "Enterprise Server ".$OSVER,   /*prod*/
			$names[5] => $type,  /*type*/
			$names[6] => trim($arr[3],"'"), /*date*/
		];

		$vuln_date=date_create(trim($arr[3],"'"));
		if ($vuln_date > $last_run_date) {
	  		$words[] = $hash;
		};
	};

	$tok = strtok($delim);
}

unset($data); // clear mem
strtok('', ''); //clear mem


#print_r($words);
#print "\"$ref\",\"$urgency\",\"$url\",\"$descr\",\"$prod\",\"$type\",\"$date\"\n";

#var_dump($words);

#print json_encode($words);

$output = fopen($REPORT,'w') or die("Can't open output");
fputcsv($output, $names);
foreach($words as $word) {
    fputcsv($output, $word);
}
fclose($output) or die("Can't close output");

# write today back to the file - done externally now as we ru this multiple times.
#file_put_contents($last_run_file, date('Y-m-d') );


?>

