#!/usr/bin/php
<?php

$options = getopt("r:");

$OSVER=abs($options['r']);

function getOnlineTableData($URL,$TABLE) {

	$dom = new DOMDocument();  

	// https://stackoverflow.com/questions/8287152/parse-html-table-using-file-get-contents-to-php-array

	$errorlevel=error_reporting();
	error_reporting($errorlevel & ~E_WARNING);
	//load the html  
	$html = $dom->loadHTMLFile($URL);
	error_reporting($errorlevel);  


	  //discard white space   
	$dom->preserveWhiteSpace = false;   

	  //the table by its tag name  
	#$tables = $dom->getElementsByTagName('xml');   


	#if ($tables->length==0) {
	#	echo "no results\n";
	#	return NULL;
	#};

	$rows = $dom->getElementsByTagName('tr');   
	  // get each column by tag name  
	#$cols = $rows->item(0)->getElementsByTagName('th');   
	$row_headers = ["Category","Severity","ID","Title","Release Date"];


	#foreach ($cols as $node) {
	    //print $node->nodeValue."\n";   
	#    $row_headers[] = $node->nodeValue;
	#}   

	$table = array();
	  //get all rows from the table  
	$rows = $dom->getElementsByTagName('tr');   
	foreach ($rows as $row)   
	{   
	   // get each column by tag name  
	    $cols = $row->getElementsByTagName('td');   
	    $row = array();
	    $i=0;
	    foreach ($cols as $node) {
	    	$val = $node->nodeValue;
		$children=$node->getElementsByTagName('a');
		$arr=NULL;
		$data=NULL;
		if ($children->length > 0) {
			foreach ($children as $child) {
				$arr['href']=$child->getAttribute('href');
				$arr['text']=$child->nodeValue;
			};
			$data=$arr;
		} else {
	    		$data = $val;
		};
			

		$row[$row_headers[$i]] = $data;
		$i++;
	    }   
	    $table[] = $row;
	}   
return $table;
};

function getOnlineSUSETableData($URL,$TABLE) {

	$dom = new DOMDocument();  

	$table=array();

	$errorlevel=error_reporting();
	error_reporting($errorlevel & ~E_WARNING);
	//load the html  
	$html = $dom->loadHTMLFile($URL);
	error_reporting($errorlevel);  

	  //discard white space   
	$dom->preserveWhiteSpace = false;   

	$tables = $dom->getElementsByTagName('table');   

	if ($tables->length==0) {
		echo "no results\n";
		return NULL;
	};

	$rows = $tables->item($TABLE)->getElementsByTagName('tr');   
	foreach ($rows as $row)   
	{  
	   // get each column by tag name  
	    $cols = $row->getElementsByTagName('td');   
	    $row = array();
		$header=$cols->item(0)->nodeValue;
		$value=$cols->item(1)->nodeValue;

		if ( $header == "Affected Products:" ) {
			$children=$cols->item(1)->getElementsByTagName('li');
			$arr=NULL;
			if ($children->length > 0) {
				foreach ($children as $child) {

					$arr[]=$child->nodeValue;
				};
				$value = $arr;
			};
		};

		$table["$header"] =  $value ;
	};


# SUSE does not format the page very nicely liek redhat does so we need to find
#  every bullet point and search for a CVE number

	$lis = $dom->getElementsByTagName('li');   
	foreach ($lis as $li) {
		$value=$li->nodeValue;

		#if (preg_match('/http:\/\/support\.novell\.com\/security\/cve\//',$value)) {
		if (preg_match('|http://support.novell.com/security/cve/(.*)?\.html|',$value,$matches)) {
			$cve=$matches[1];
			$table["cves"][$cve]=$value;
		};
	};

return $table;
};


function getOnlineCVEscore($URL,$TABLE) {

	$dom = new DOMDocument();  

	$errorlevel=error_reporting();
	error_reporting($errorlevel & ~E_WARNING);
	//load the html  
	$html = $dom->loadHTMLFile($URL);
	error_reporting($errorlevel);  

	  //discard white space   
	$dom->preserveWhiteSpace = false;   

	$score='undefined';

       $ps = $dom->getElementsByTagName('p');
        foreach ($ps as $p) {
                $value=$p->nodeValue;

                if (preg_match('|(\d+\.\d+) \(AV:|',$value,$matches)) {
                        $score=$matches[1];
			break;
                };
        };
 
return $score;
};


$table=getOnlineTableData("suse-server.html",0);

#print_r($table);

$last_run_file="suse-lastrun";

$last_run_date=date_create("1970-1-1");

if (file_exists($last_run_file)) {
        $read_date=file_get_contents($last_run_file);
        $last_run_date=date_create($read_date);
};


print "Reference, Urgency, URL, Description, Products, Type, ReleaseDate\n";
foreach ($table as $row) {

	if (isset($row['Category'])) {

		$date=$row['Release Date'];
		$vuln_date=date_create($date);

		if ($vuln_date > $last_run_date) {

			$ref=$row['ID'];

			$type=$row['Category'];

			$url=$row['Title']['href'];

			$urgency=$row['Severity'];
			if ($type=="recommended") { $urgency = "recommended"; };
			if ($type=="optional") { $urgency = ""; };
			if ($type=="YOU") { $urgency = "recommended"; };

			$descr=$row['Title']['text'];
			$prod="Enterprise Server ".$OSVER ;
			
			$date=$row['Release Date'];


			print "\"$ref\",\"$urgency\",\"$url\",\"$descr\",\"$prod\",\"$type\",\"$date\"\n";
		};
	};
};

# write today back to the file - done externally now as we ru this multiple times.
#file_put_contents($last_run_file, date('Y-m-d') );

?>
