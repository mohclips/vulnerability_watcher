#!/usr/bin/php
<?php

function getOnlineTableData($URL,$TABLE) {

	$dom = new DOMDocument();  

	// https://stackoverflow.com/questions/8287152/parse-html-table-using-file-get-contents-to-php-array

	$errorlevel=error_reporting();
	error_reporting($errorlevel & ~E_WARNING);
	//load the html  
	$html = $dom->loadHTMLFile($URL);
	error_reporting($errorlevel);  


	  //discard white space   
	$dom->preserveWhiteSpace = false;   

	  //the table by its tag name  
	$tables = $dom->getElementsByTagName('table');   


	if ($tables->length==0) {
		echo "no results\n";
		exit(1);
	};

	$rows = $tables->item($TABLE)->getElementsByTagName('tr');   
	  // get each column by tag name  
	$cols = $rows->item(0)->getElementsByTagName('th');   
	$row_headers = NULL;


	foreach ($cols as $node) {
	    //print $node->nodeValue."\n";   
	    $row_headers[] = $node->nodeValue;
	}   

	$table = array();
	  //get all rows from the table  
	$rows = $tables->item($TABLE)->getElementsByTagName('tr');   
	foreach ($rows as $row)   
	{   
	   // get each column by tag name  
	    $cols = $row->getElementsByTagName('td');   
	    $row = array();
	    $i=0;
	    foreach ($cols as $node) {
		# code...
		//print $node->nodeValue."\n";   
		if($row_headers==NULL)
		    $row[] = $node->nodeValue;
		else
		    $value = $node->nodeValue;
			if ($value==NULL) {
				// look for an image file
				$children=$node->childNodes;
				if ($children->length == 1) {
					$value=$children->item(0)->getAttribute('alt');
				};
				if ($value==NULL) {
					$value="";
				};
			};
			$row[$row_headers[$i]] = $value;
		$i++;
	    }   
	    $table[] = $row;
	}   
return $table;
};

function getOnlineRHSATableData($URL,$TABLE) {

	$dom = new DOMDocument();  

	$errorlevel=error_reporting();
	error_reporting($errorlevel & ~E_WARNING);
	//load the html  
	$html = $dom->loadHTMLFile($URL);
	error_reporting($errorlevel);  

	  //discard white space   
	$dom->preserveWhiteSpace = false;   

	$tables = $dom->getElementsByTagName('table');   

	if ($tables->length==0) {
		echo "no results\n";
		exit(1);
	};

	$cols1 = $tables->item($TABLE)->getElementsByTagName('th');   
	$cols2 = $tables->item($TABLE)->getElementsByTagName('td');   

	// headers
	foreach ($cols1 as $node) {
	    //print $node->nodeValue."\n";   
	    $headers[] = $node->nodeValue;
	}   

	// data
	foreach ($cols2 as $node) {
	    //print $node->nodeValue."\n";   
	    $val = $node->nodeValue;
		$children=$node->getElementsByTagName('a');
		$arr=NULL;
		if ($children->length > 0) {
			foreach ($children as $child) {
				#$arr[]=$child->getAttribute('src');
				$arr[]=$child->nodeValue;
			};
			$data[]=$arr;
		} else {
	    		$data[] = $val;
		};
	}   

	// merge headers and data
	for ($x = 0; $x <= count($headers)-1; $x++) {
	    $table[$headers[$x]] = $data[$x];
	} 
  
return $table;
};


function getOnlineCVETableData($URL,$TABLE) {

	$dom = new DOMDocument();  

	$errorlevel=error_reporting();
	error_reporting($errorlevel & ~E_WARNING);
	//load the html  
	$html = $dom->loadHTMLFile($URL);
	error_reporting($errorlevel);  

	  //discard white space   
	$dom->preserveWhiteSpace = false;   

	$tables = $dom->getElementsByTagName('table');   

	if ($tables->length==0) {
		echo "no results\n";
		exit(1);
	};

	$cols1 = $tables->item($TABLE)->getElementsByTagName('th');   
	$cols2 = $tables->item($TABLE)->getElementsByTagName('td');   

	// headers
	foreach ($cols1 as $node) {
	    //print $node->nodeValue."\n";   
	    $headers[] = $node->nodeValue;
	}   

	// data
	foreach ($cols2 as $node) {
	    //print $node->nodeValue."\n";   
	    $val = $node->nodeValue;
		$children=$node->getElementsByTagName('a');
		$arr=NULL;
		if ($children->length > 0) {
			foreach ($children as $child) {
				#$arr[]=$child->getAttribute('src');
				$arr[]=$child->nodeValue;
			};
			$data[]=$arr;
		} else {
	    		$data[] = $val;
		};
	}   

	// merge headers and data
	for ($x = 0; $x <= count($headers)-1; $x++) {
	    $table[$headers[$x]] = $data[$x];
	} 
  
return $table;
};


$table=getOnlineTableData("rhel-server-6-errata.html",2);

print_r($table);

$last_run_file="redhat-lastrun";

$last_run_date=date_create("1970-1-1");

if (file_exists($last_run_file)) {
	$read_date=file_get_contents($last_run_file);
	$last_run_date=date_create($read_date);
};

#print "last run date: ".date_format($last_run_date, 'Y-m-d H:i:s')."\n";

#print_r($table);

# # we cant use this as we need the columns in a certain order - shame
#$output = fopen("redhat.csv",'w') or die("Can't open redhat.csv");
#foreach($table as $prod) {
#    fputcsv($output, $prod);
#}
#fclose($output) or die("Can't close redhat.csv");

print "Reference, Urgency, URL, Description, Products, Type, ReleaseDate\n";

foreach ($table as $row) {

	if (isset($row['Advisory'])) {

		$date=$row['Date'];
		$vuln_date=date_create($date);

		if ($vuln_date > $last_run_date) {

			$ref=$row['Advisory'];
			$ref2=str_replace(":","-",$ref);

			$type=$row['Type'];

			$urgency=$row['Severity'];
			if ($urgency==" " && $type == "Bug Fix Advisory") { 
				$urgency = "Recommended"; 
			};

			$url = "https://rhn.redhat.com/errata/".$ref2.".html";

			$descr=$row['Synopsis'];
			$prod="RedHat Server 6";

			print "\"$ref\",\"$urgency\",\"$url\",\"$descr\",\"$prod\",\"$type\",\"$date\"\n";
		};
	};
};

# write today back to the file
file_put_contents($last_run_file, date('Y-m-d') );

?>
