import mailbox
import re
import sys, getopt

def print_payload(message):
  # if the message is multipart, its payload is a list of messages
  if message.is_multipart():
    for part in message.get_payload(): 
      print_payload(part)
  else:
    print message.get_payload(decode=True)

myopts, args = getopt.getopt(sys.argv[1:],"r:")

for o, a in myopts:
    if o == '-r':
        ifile=a
    else:
        print("Usage: %s -r input " % sys.argv[0])

mbox = mailbox.mbox(ifile)


#print "Reference,Urgency,URL,Description,Products,Type,ReleaseDate"

for message in mbox:
  date=''.join(message['date'].splitlines())
  subj=' '.join(''.join(message['subject'].splitlines()).split())

#[El-errata] ELBA-2015-3017 Oracle Linux 5 udev bug fix update
#[El-errata] ELSA-2015-3020 Important: Oracle Linux 6 Unbreakable Enterprise kernel security update
#[El-errata] ELEA-2015-0746 Oracle Linux 7 cyrus-imapd enhancement update
#[El-errata] Oracle Linux 7 Update 1 Release for x86_64

#[El-errata] ELSA-2007-0354 Critical: Enterprise Linux 5 samba security update

  SEC=r'\[El-errata\] (?P<ID>ELSA\S+) (?P<LEVEL>\S+): [Oracle|Enterprise]+ Linux (?P<OS>\d) (?P<DESC>.*)'
  BUG=r'\[El-errata\] (?P<ID>ELBA\S+) [Oracle|Enterprise]+ Linux (?P<OS>\d) (?P<DESC>.*)'
  ENH=r'\[El-errata\] (?P<ID>ELEA\S+) [Oracle|Enterprise]+ Linux (?P<OS>\d) (?P<DESC>.*)'
  #UPD=r'\[El-errata\] Oracle Linux (?P<OS>\d) (?P<ID>Update \d+) (?P<DESC>Release .*)'


  match=re.match(SEC, subj)
  if not match:
    match=re.match(BUG, subj)
    if not match:
      match=re.match(ENH, subj)
      if not match:
        #match=re.match(UPD, subj)
        #if not match:
        print >> sys.stderr,"No match on: %s %s" % (date, subj)
  
  if match:
    # create a dictionary based on the regex groups ID, LEVEL, OS, etc   
    d = match.groupdict()


    # Loop over dictionary with for-loop.
    #for t in d:
    #    print "%s = %s" % (t, d[t])

    ID=d['ID']
    if 'ELSA' in ID:
      LEVEL=d['LEVEL']
      TYPE="Security"
    elif 'ELBA' in ID:
      LEVEL=""
      TYPE="Bug Fix"
    elif 'ELEA' in ID:
      LEVEL=""
      TYPE="Enhancement"
    else:
      LEVEL=""
      TYPE="unknown"


    OS="Enterprise Linux "+d['OS']
    DESC=d['DESC']

    #http://linux.oracle.com/errata/ELBA-2015-0274.html
    URL="http://linux.oracle.com/errata/"+ID+".html"
   
    DATE=date
 
    #Reference,Urgency,URL,Description,Products,Type,ReleaseDate
    print "\"%s\",\"%s\",\"%s\",\"%s\",\"%s\",\"%s\",\"%s\"" % (ID,LEVEL,URL,DESC,OS,TYPE,DATE)
       

